{
  "hash": "d01ba8084f79d9ceacca7bd1d68b9b6d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Pyroclastic Flow\"\nformat: html\ndate: \"2022-12-17\"\ndraft: true\neval: false\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(mistlecode)\n\noptions(scipen = 999)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\njets <-\n  'input2.txt' |>\n  readLines() |>\n  strsplit('') |>\n  unlist() |>\n  dplyr::case_match(\n    '<' ~ -1,\n    '>' ~ 1\n  )\n\nrocks <-\n  list(\n    matrix(\"@\", 1, 4),\n    matrix(c(\"\", \"@\", \"\", \"@\", \"@\", \"@\", \"\", \"@\", \"\"), 3, 3),\n    matrix(c(\"\", \"\", \"@\", \"\", \"\", \"@\", \"@\", \"@\", \"@\"), 3, 3),\n    matrix(\"@\", 4, 1),\n    matrix(\"@\", 2, 2)\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nindex <- function(x, n) {\n  stopifnot(length(x) > 0)\n  n <- n %% length(x)\n  n[n == 0] <- length(x)\n  return(n)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nchamber <- structure(\n  list(\n    'cave' = matrix('', nrow = 3, ncol = 7),\n    'rock' = rocks[[1]],\n    'i' = 1\n  ),\n  class = 'chamber'\n)\n\npad_rock <- function(rock, left_pad = 2) {\n  left <- matrix('', nrow = nrow(rock), ncol = left_pad)\n  right <- matrix('', nrow = nrow(rock), ncol = 7 - ncol(rock) - ncol(left))\n  cbind(left, rock, right)\n}\n\nnew_rock <- function(chamber) {\n  chamber$rock <- \n    rocks[[index(rocks, chamber$i)]] |>\n    pad_rock()\n  return(chamber)\n}\n\ndo_push <- function(rock, jets, cols = NULL) {\n  rock_cols <- which(colSums(rock != '') != 0)\n  if (length(jets) == 0) {\n      rock <-\n        rock[, rock_cols] |>\n        `dim<-`(c(nrow(rock), length(rock_cols))) |>\n        pad_rock(min(cols))\n    return(rock)\n  }\n  new_cols <- rock_cols + jets[1]\n  if (any(new_cols < 1 | new_cols > 7)) \n    do_push(rock, jets[-1], rock_cols)\n  else \n    do_push(rock, jets[-1], new_cols)\n}\n\nrock_push_3 <- function(chamber) {\n  i <- chamber$i\n  chamber$rock <- do_push(chamber$rock, jets[index(jets, i:(i+3))])\n  return(chamber)\n}\n\nmatrix_join <- function(x, y, false = '', fn = \\(z) z != false) {\n  stopifnot(dim(x) == dim(y))\n  copy <- matrix(false, nrow(x), ncol(x))\n  fn_x <- fn(x); fn_y <- fn(y);\n  copy[fn_x] <- x[fn_x]\n  copy[fn_y] <- y[fn_y]\n  return(copy)\n}\n\nrock_fall <- function(chamber) {\n  for (i in 3:1) {\n    placeholder <- matrix('', 3 - i, 7)\n    cave <- rbind(placeholder, chamber$cave[1:i,])\n    print(cave)\n    print(chamber$rock)\n    pass <- all((chamber$rock == '' & cave == '') | chamber$rock != cave)\n    if (pass) {\n      chamber$cave <- \n        chamber$cave[-(1:i)] |>\n        matrix(ncol = 7)\n      chamber$cave <- rbind(matrix_join(cave, chamber$rock), chamber$cave)\n      return(chamber)\n    }\n  }\n  chamber$cave <- rbind(chamber$rock, chamber$cave)\n  return(chamber)\n}\n\nrock_push <- function(chamber) {\n  i <- chamber$i\n  chamber$rock <- do_push(chamber$rock, jets[index(jets, i)])\n  return(chamber)\n}\n\ndo_step <- function(chamber) {\n  chamber |>\n    rock_fall() |>\n    rock_push()\n}\n\nchamber |>\n  new_rock() |>\n  rock_push_3() |>\n  do_step()\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}